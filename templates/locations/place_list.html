{% extends "base.html" %}
{% load static %}

{% block content %}

<style>
    /* üîπ PAGE WRAPPER */
    .place-wrapper {
        min-height: 100vh;
        background: linear-gradient(135deg, #b2f7ef, #d6fff6, #fff9c4);
        padding: 20px;
    }

    /* üîπ CARD CONTAINER */
    .place-container {
        max-width: 520px;
        margin: auto;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 22px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        animation: fadeUp 0.8s ease;
    }

    @keyframes fadeUp {
        from {
            opacity: 0;
            transform: translateY(25px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .place-header {
        text-align: center;
        margin-bottom: 20px;
    }

    .place-header h2 {
        font-size: 1.6rem;
        font-weight: 700;
        color: #006d77;
    }

    label {
        font-weight: 600;
    }

    input {
        width: 100%;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        margin-bottom: 12px;
    }

    button {
        width: 100%;
        padding: 14px;
        border-radius: 14px;
        border: none;
        background: linear-gradient(135deg, #00b4d8, #0077b6);
        color: white;
        font-weight: 600;
        cursor: pointer;
    }

    #map {
        height: 350px;
        border-radius: 14px;
        margin-bottom: 20px;
    }

    .place-card {
        background: white;
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 15px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, .1);
    }

    .verified {
        background: #1da1f2;
        color: white;
        font-size: .75rem;
        padding: 4px 8px;
        border-radius: 999px;
        font-weight: 600;
    }
</style>

<div class="place-wrapper">
    <div class="place-container">

        <div class="place-header">
            <h2>{{ category|title }} Near You</h2>
        </div>

        <!-- üîπ FORM -->
        <form method="POST">
            {% csrf_token %}
            <label>Show results within (km)</label>
            <input type="number" name="distance" min="1" required>

            <input type="hidden" name="lat" id="lat">
            <input type="hidden" name="lng" id="lng">

            <button>Find</button>
        </form>

        <!-- üîπ SIMPLE & RELIABLE GEOLOCATION (LIKE OLD VERSION) -->
        <script>
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    document.getElementById("lat").value = position.coords.latitude;
                    document.getElementById("lng").value = position.coords.longitude;
                },
                function (error) {
                    alert("Please allow location access to find nearby services.");
                }
            );
        </script>

        {% if places %}
        <hr>

        <!-- üîπ MAP -->
        <div id="map"></div>

        <script>
            const places = [];
            {% for place in places %}
            places.push({
                name: "{{ place.name|escapejs }}",
                lat: {{ place.latitude }},
                lng: {{ place.longitude }},
                distance: {{ place.distance }}
        });
            {% endfor %}

            const map = L.map('map').setView([places[0].lat, places[0].lng], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            places.forEach(place => {
                L.marker([place.lat, place.lng])
                    .addTo(map)
                    .bindPopup(`<b>${place.name}</b><br>${place.distance} km away`);
            });
        </script>


        {% for place in places %}
        <a href="{% url 'place_detail' place.id %}" style="text-decoration:none;color:inherit;">

            <div class="place-card">
                <h5>
                    {{ place.name }}
                    <span class="verified">‚úî Verified</span>
                </h5>

                <p>{{ place.address }}</p>
                <p><strong>{{ place.distance }} km away</strong></p>

                <a href="https://www.google.com/maps/dir/?api=1&destination={{ place.latitude }},{{ place.longitude }}"
                    target="_blank" style="
        display:inline-block;
        margin-top:8px;
        padding:8px 12px;
        background:#28a745;
        color:white;
        border-radius:8px;
        font-size:0.85rem;
        text-decoration:none;
        font-weight:600;
      ">
                    üó∫Ô∏è Open in Google Maps
                </a>
            </div>

            {% endfor %}

            {% else %}
            <p class="text-center mt-3">No places found.</p>
            {% endif %}

    </div>
</div>
</a>

{% endblock %}