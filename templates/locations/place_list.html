{% extends "base.html" %}


{% block content %}

<style>
    /* üîπ PAGE WRAPPER */
    .place-wrapper {
        min-height: 100vh;
        background: linear-gradient(135deg, #b2f7ef, #d6fff6, #fff9c4);
        padding: 20px;
    }

    /* üîπ CARD CONTAINER */
    .place-container {
        max-width: 520px;
        margin: auto;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 22px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        animation: fadeUp 0.8s ease;
    }

    /* üîπ ANIMATION */
    @keyframes fadeUp {
        from {
            opacity: 0;
            transform: translateY(25px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* üîπ HEADER */
    .place-header {
        text-align: center;
        margin-bottom: 20px;
    }

    .place-header h2 {
        font-size: 1.6rem;
        font-weight: 700;
        color: #006d77;
    }

    /* üîπ FORM */
    label {
        font-weight: 600;
        margin-bottom: 6px;
    }

    input {
        width: 100%;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #ccc;
        margin-bottom: 12px;
    }

    button {
        width: 100%;
        padding: 14px;
        border-radius: 14px;
        border: none;
        background: linear-gradient(135deg, #00b4d8, #0077b6);
        color: white;
        font-weight: 600;
        cursor: pointer;
    }

    /* üîπ MAP */
    #map {
        height: 350px;
        border-radius: 14px;
        margin-bottom: 20px;
    }

    /* üîπ RESULT CARD */
    .place-card {
        background: white;
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 15px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .place-card h5 {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* üîπ VERIFIED BADGE */
    .verified {
        background: #1da1f2;
        color: white;
        font-size: 0.75rem;
        padding: 4px 8px;
        border-radius: 999px;
        font-weight: 600;
        box-shadow: 0 0 10px rgba(29, 161, 242, 0.6);
    }
</style>

<div class="place-wrapper">
    <div class="place-container">

        <!-- üîπ HEADER -->
        <div class="place-header">
            <h2>{{ category|title }} Near You</h2>
        </div>

        <!-- üîπ DISTANCE FORM -->
        <form method="POST" onsubmit="return checkLocation();">
            {% csrf_token %}

            <label>Show results within (km)</label>
            <input type="number" name="distance" min="1" required>

            <input type="hidden" name="lat" id="lat">
            <input type="hidden" name="lng" id="lng">

            <button>Find</button>
        </form>

        <!-- üîπ GEOLOCATION -->
        <script>
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    document.getElementById("lat").value = position.coords.latitude;
                    document.getElementById("lng").value = position.coords.longitude;

                    console.log("USER LOCATION:",
                        position.coords.latitude,
                        position.coords.longitude
                    );
                },
                function (error) {
                    alert("Location error: " + error.message);
                },
                {
                    enableHighAccuracy: true,   // üî• KEY FIX
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        </script>


        {% if places %}
        <hr>

        <!-- üîπ MAP -->
        <div id="map"></div>

        <script>
            const places = [];
            {% for place in places %}
            places.push({
                name: "{{ place.name|escapejs }}",
                lat: {{ place.latitude }},
                lng: {{ place.longitude }},
                distance: {{ place.distance }}
        });
            {% endfor %}

            const map = L.map('map').setView([places[0].lat, places[0].lng], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            places.forEach(place => {
                L.marker([place.lat, place.lng])
                    .addTo(map)
                    .bindPopup(`<b>${place.name}</b><br>${place.distance} km away`);
            });
        </script>

        <!-- üîπ RESULTS -->
        {% for place in places %}
        <div class="place-card">
            <h5>
                {{ place.name }}
                <span class="verified">‚úî Verified</span>
            </h5>
            <p>{{ place.address }}</p>
            <p><strong>{{ place.distance }} km away</strong></p>

            <a href="https://www.google.com/maps/dir/?api=1&destination={{ place.latitude }},{{ place.longitude }}"
                target="_blank" class="btn btn-success btn-sm">
                üó∫Ô∏è Open in Google Maps
            </a>
        </div>
        {% endfor %}

        {% else %}
        <p class="text-center mt-3">No places found in selected distance.</p>
        {% endif %}

    </div>
</div>

{% endblock %}