{% extends "base.html" %}
{% load static %}

{% block content %}

<h2 class="mb-3">{{ category|title }} Near You</h2>

<!-- üîπ DISTANCE + LOCATION FORM -->
<form method="POST" onsubmit="return checkLocation();" class="mb-4">
    {% csrf_token %}

    <label class="form-label">Show results within (km)</label>
    <input type="number" name="distance" required min="1" class="form-control mb-2">

    <input type="hidden" name="lat" id="lat">
    <input type="hidden" name="lng" id="lng">

    <button class="btn btn-primary mt-2">Find</button>
</form>

<!-- üîπ GEOLOCATION -->
<script>
    navigator.geolocation.getCurrentPosition(
        function (position) {
            document.getElementById("lat").value = position.coords.latitude;
            document.getElementById("lng").value = position.coords.longitude;
        },
        function () {
            alert("Location access is required to find nearby services.");
        }
    );

    function checkLocation() {
        const lat = document.getElementById("lat").value;
        const lng = document.getElementById("lng").value;

        if (!lat || !lng) {
            alert("Please allow location access to continue.");
            return false;
        }
        return true;
    }
</script>

{% if places %}
<hr>

<!-- üîπ MAP PREVIEW -->
<div id="map" style="height: 400px; border-radius: 12px;" class="mb-4"></div>

<script>
    const places = [];
    {% for place in places %}
    places.push({
        name: "{{ place.name|default:''|escapejs }}",
        lat: {{ place.latitude }},
        lng: {{ place.longitude }},
        distance: {{ place.distance }}
});
    {% endfor %}

    if (places.length > 0) {
        const map = L.map('map').setView(
            [places[0].lat, places[0].lng],
            14
        );

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        places.forEach(place => {
            L.marker([place.lat, place.lng])
                .addTo(map)
                .bindPopup(
                    `<b>${place.name}</b><br>${place.distance} km away`
                );
        });
    }
</script>


<!-- üîπ RESULTS LIST -->
{% for place in places %}
<div class="card mb-3">
    <div class="card-body">
        <h5>{{ place.name }}</h5>
        <p>{{ place.address }}</p>
        <p><strong>{{ place.distance }} km away</strong></p>

        <a href="https://www.google.com/maps/dir/?api=1&destination={{ place.latitude }},{{ place.longitude }}"
            target="_blank" class="btn btn-success">
            üó∫Ô∏è Open in Google Maps
        </a>
    </div>
</div>
{% endfor %}

{% else %}
<p>No places found in selected distance.</p>
{% endif %}

{% endblock %}